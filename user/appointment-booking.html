<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LRU HeartCare | จองการนัดหมาย</title>
    <link rel="stylesheet" href="/css/booking.css">
</head>
<body>
    <script>
        // JavaScript สำหรับการทำงานของ Dropdown (จากหน้าหลัก)
        document.addEventListener('DOMContentLoaded', function () {
            const dropdownToggle = document.querySelector('.dropdown-toggle');
            const dropdown = dropdownToggle.closest('.dropdown');
            const arrow = dropdownToggle.querySelector('.arrow');
            
            if (dropdownToggle && dropdown && arrow) { // Ensure elements exist
                dropdownToggle.addEventListener('click', function () {
                    dropdown.classList.toggle('show');
                    arrow.textContent = dropdown.classList.contains('show') ? '▲' : '▼';
                });
            }
            
            document.addEventListener('click', function (e) {
                if (dropdown && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('show');
                    if (arrow) arrow.textContent = '▼';
                }
            });

            // JavaScript สำหรับการดึงข้อมูลนักจิตวิทยาจาก URL และแสดงในหน้าจอง
            const urlParams = new URLSearchParams(window.location.search);
            const psychologistId = urlParams.get('psy'); // e.g., "somchai"

            const psychologists = {
                'somchai': {
                    name: 'นายสมชาย ใจดี',
                    specialty: 'ผู้เชี่ยวชาญ: ความเครียดและการเรียน',
                    bio: 'นายสมชายมีประสบการณ์ในการให้คำปรึกษาแก่นักศึกษาที่เผชิญกับความกดดันด้านการเรียนและการจัดการความเครียด เขามุ่งเน้นการสร้างพื้นที่ปลอดภัยและสนับสนุนให้นักศึกษาค้นพบแนวทางแก้ไขปัญหาด้วยตนเอง',
                    image: 'https://cdn.discordapp.com/attachments/1072487445133803531/1354093902080249906/image.png?ex=68142878&is=6812d6f8&hm=4326e0e78ed1dd3cc056610562fb36610562fb36652876380cd738d91db4d3254a79092ba5&'
                },
                'maneerat': {
                    name: 'นางสาวมณีรัตน์ สุขใจ',
                    specialty: 'ผู้เชี่ยวชาญ: ความสัมพันธ์และอารมณ์',
                    bio: 'นางสาวมณีรัตน์ช่วยให้นักศึกษาพัฒนาทักษะการสื่อสาร จัดการอารมณ์ และสร้างความสัมพันธ์ที่ดีกับผู้อื่น เธอมีความเข้าใจอย่างลึกซึ้งในพลวัตของความสัมพันธ์และพร้อมที่จะนำทางคุณ',
                    image: 'https://cdn.discordapp.com/attachments/1072487445133803531/1354093987342061588/image.png?ex=6814288c&is=6812d70c&hm=b272b9cd7ecd3aa10b03f283638ae3c6c8048de67413cb9c3a79d1fb59ecb16b&'
                },
                'oranong': {
                    name: 'แพทย์หญิงอรอนงค์ รักษาใจ',
                    specialty: 'ผู้เชี่ยวชาญ: การพัฒนาตนเอง',
                    bio: 'แพทย์หญิงอรอนงค์เน้นการเสริมสร้างความมั่นใจ ค้นหาศักยภาพ และวางแผนเพื่ออนาคตที่สดใส เธอเชื่อว่าทุกคนมีศักยภาพในการเติบโตและเปลี่ยนแปลง',
                    image: 'https://cdn.discordapp.com/attachments/1072487445133803531/1354094057793523720/image.png?ex=6814289d&is=6812d71d&hm=a34d2c8467172292b92bfbd8942cfdd22466819aba3b7be7cf4471115f850eb&'
                },
                'pimpa': {
                    name: 'แพทย์หญิงพิมพา สุขสันต์',
                    specialty: 'ผู้เชี่ยวชาญ: ภาวะซึมเศร้าและวิตกกังวล',
                    bio: 'แพทย์หญิงพิมพาให้การสนับสนุนผู้ที่มีภาวะซึมเศร้าและวิตกกังวล เพื่อให้กลับมามีคุณภาพชีวิตที่ดีขึ้น ด้วยแนวทางที่อ่อนโยนและเข้าใจ',
                    image: 'https://placehold.co/150x150/87CEEB/ffffff?text=Dr.+Pim'
                },
                'deeprom': {
                    name: 'นายดีพร้อม ยิ้มสู้',
                    specialty: 'ผู้เชี่ยวชาญ: การปรับตัวและทักษะชีวิต',
                    bio: 'นายดีพร้อมช่วยให้นักศึกษาปรับตัวเข้ากับสภาพแวดล้อมใหม่ๆ และพัฒนาทักษะชีวิตที่จำเป็น ด้วยการนำเสนอแนวคิดที่ใช้ได้จริงในชีวิตประจำวัน',
                    image: 'https://placehold.co/150x150/FF69B4/ffffff?text=Mr.+Dee'
                },
                'chainant': {
                    name: 'นางสาวชัยนันท์ มีชัย',
                    specialty: 'ผู้เชี่ยวชาญ: การเรียนรู้และอาชีพ',
                    bio: 'นางสาวชัยนันท์ให้คำแนะนำด้านการเรียนรู้ การวางแผนอาชีพ และการค้นหาเส้นทางที่เหมาะสม เพื่อให้นักศึกษาบรรลุเป้าหมายที่ตั้งไว้',
                    image: 'https://placehold.co/150x150/4682B4/ffffff?text=Ms.+Chai'
                }
            };

            const psychologistInfoCard = document.getElementById('psychologistInfoCard');
            const appointmentForm = document.getElementById('appointmentForm');
            const selectedPsychologist = psychologists[psychologistId];

            // Elements for the new Psychologist Detail Modal
            const psychologistDetailModal = document.getElementById('psychologistDetailModal');
            const detailPsyImage = document.getElementById('detailPsyImage');
            const detailPsyName = document.getElementById('detailPsyName');
            const detailPsySpecialty = document.getElementById('detailPsySpecialty');
            const detailPsyBio = document.getElementById('detailPsyBio');
            const btnClosePsyDetailModal = document.getElementById('btnClosePsyDetailModal');
            const btnBookNowFromPsyModal = document.getElementById('btnBookNowFromPsyModal');
            const specialtyTagSpan = document.getElementById('specialtyTagSpan'); // Get reference to the specialty tag span

            // Elements for the new Appointment Confirmation Modal
            const appointmentConfirmationModal = document.getElementById('appointmentConfirmationModal');
            // **แก้ไข:** เพิ่มการอ้างอิงถึง element ที่จะแสดงผลช่องทางการนัดหมาย
            const confirmMethod = document.getElementById('confirmMethod'); 
            const confirmDate = document.getElementById('confirmDate');
            const confirmTime = document.getElementById('confirmTime');
            const confirmFullName = document.getElementById('confirmFullName');
            const confirmStudentId = document.getElementById('confirmStudentId');
            const confirmMajor = document.getElementById('confirmMajor');
            const confirmFaculty = document.getElementById('confirmFaculty');
            const confirmReason = document.getElementById('confirmReason');
            const confirmPsychologist = document.getElementById('confirmPsychologist');
            const btnConfirmBooking = document.getElementById('btnConfirmBooking');
            const btnEditBooking = document.getElementById('btnEditBooking');

            if (selectedPsychologist) {
                document.getElementById('psychologistImage').src = selectedPsychologist.image;
                document.getElementById('psychologistName').textContent = selectedPsychologist.name;
                document.getElementById('psychologistSpecialty').textContent = selectedPsychologist.specialty;
                document.getElementById('psychologistBio').textContent = selectedPsychologist.bio;
                // Ensure the form is visible if a valid psychologist is found
                appointmentForm.style.display = 'block'; 

                // Add event listener to the specialty tag to open the modal
                if (specialtyTagSpan) {
                    specialtyTagSpan.addEventListener('click', function() {
                        detailPsyImage.src = selectedPsychologist.image;
                        detailPsyName.textContent = selectedPsychologist.name;
                        detailPsySpecialty.textContent = selectedPsychologist.specialty;
                        detailPsyBio.textContent = selectedPsychologist.bio;
                        psychologistDetailModal.classList.add('show');
                    });
                }

                // Close modal when clicking the close button
                if (btnClosePsyDetailModal) {
                    btnClosePsyDetailModal.addEventListener('click', function() {
                        psychologistDetailModal.classList.remove('show');
                    });
                }

                // Handle "Book Now" button in the psychologist detail modal
                if (btnBookNowFromPsyModal) {
                    btnBookNowFromPsyModal.addEventListener('click', function() {
                        psychologistDetailModal.classList.remove('show'); // Hide modal
                        // Scroll to the booking form
                        appointmentForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    });
                }

                // Close modal if user clicks outside
                psychologistDetailModal.addEventListener('click', function(e) {
                    if (e.target === psychologistDetailModal) {
                        psychologistDetailModal.classList.remove('show');
                    }
                });

            } else {
                // If psychologist ID is not found, hide the original info card and form
                if (psychologistInfoCard) psychologistInfoCard.style.display = 'none';
                if (appointmentForm) appointmentForm.style.display = 'none'; 

                // Create a new div to display the error message
                const errorMessageDiv = document.createElement('div');
                errorMessageDiv.classList.add('psychologist-not-found');
                errorMessageDiv.innerHTML = `
                    <p style="color: var(--text-dark); margin-bottom: 25px;">ไม่พบข้อมูลนักจิตวิทยา</p>
                    <p style="color: var(--text-muted); font-size: 1rem; margin-bottom: 30px;">
                        กรุณาเลือกนักจิตวิทยาจากหน้า 'เลือกนักจิตวิทยา' เพื่อดำเนินการต่อ
                    </p>
                    <a href="Psychologist.html" class="go-back-btn">กลับไปหน้าเลือกนักจิตวิทยา</a>
                `;
                document.querySelector('.appointment-section').appendChild(errorMessageDiv);
                
                console.error('Psychologist not found for ID:', psychologistId);
            }

            // Handle form submission - Show confirmation modal
            appointmentForm.addEventListener('submit', function(event) {
                event.preventDefault(); // Prevent default form submission

                // **แก้ไข: ดึงค่าช่องทางการนัดหมายที่ถูกเลือก**
                const selectedMethodElement = document.querySelector('input[name="appointmentMethod"]:checked');
                const selectedMethod = selectedMethodElement ? selectedMethodElement.value : 'ไม่ระบุ';

                // แปลงค่าที่ได้จาก radio button ให้เป็นข้อความที่อ่านง่ายขึ้น
                let displayMethod = '';
                if (selectedMethod === 'chat') {
                    displayMethod = 'แชท';
                } else if (selectedMethod === 'clinic') {
                    displayMethod = 'คลินิก';
                } else {
                    displayMethod = 'ไม่ระบุ';
                }

                const formData = {
                    date: document.getElementById('appointmentDate').value,
                    time: document.getElementById('appointmentTime').value,
                    fullName: document.getElementById('fullName').value,
                    studentId: document.getElementById('studentId').value,
                    major: document.getElementById('major').value,
                    faculty: document.getElementById('faculty').value,
                    reason: document.getElementById('reason').value,
                    psychologist: selectedPsychologist ? selectedPsychologist.name : 'Unknown',
                    psychologistId: psychologistId, // Add psychologistId
                    status: 'รอยืนยัน', // Initial status
                    id: 'app' + Date.now(), // Simple unique ID for demonstration
                    // **แก้ไข: เพิ่มข้อมูลช่องทางที่ถูกแปลงแล้วเข้าสู่ formData**
                    appointmentMethod: displayMethod 
                };

                // Populate confirmation modal with data
                // **แก้ไข: อัปเดต element ใน modal ด้วยค่าช่องทาง**
                confirmMethod.textContent = formData.appointmentMethod;
                confirmDate.textContent = formData.date;
                confirmTime.textContent = formData.time;
                confirmFullName.textContent = formData.fullName;
                confirmStudentId.textContent = formData.studentId;
                confirmMajor.textContent = formData.major;
                confirmFaculty.textContent = formData.faculty;
                confirmReason.textContent = formData.reason;
                confirmPsychologist.textContent = formData.psychologist;

                // Store formData globally or pass it for confirmation
                appointmentConfirmationModal.dataset.formData = JSON.stringify(formData);

                appointmentConfirmationModal.classList.add('show'); // Show confirmation modal
            });

            // Handle "Confirm Booking" button in the confirmation modal
            if (btnConfirmBooking) {
                btnConfirmBooking.addEventListener('click', function() {
                    const formDataString = appointmentConfirmationModal.dataset.formData;
                    if (formDataString) {
                        const formData = JSON.parse(formDataString);
                        
                        // Save to localStorage
                        let allAppointments = [];
                        const storedAppointments = localStorage.getItem('allAppointments');
                        if (storedAppointments) {
                            try {
                                allAppointments = JSON.parse(storedAppointments);
                            } catch (e) {
                                console.error("Error parsing existing appointments:", e);
                            }
                        }
                        allAppointments.push(formData);
                        localStorage.setItem('allAppointments', JSON.stringify(allAppointments));

                        console.log('ข้อมูลการนัดหมายถูกบันทึก:', formData);
                        
                        appointmentConfirmationModal.classList.remove('show'); // Hide modal
                        alert('การนัดหมายถูกส่งเรียบร้อยแล้ว! โปรดรอการยืนยัน.');
                        window.location.href = 'Viewinfo.html'; // Redirect to Viewinfo page after booking
                    }
                });
            }

            // Handle "Edit Booking" button in the confirmation modal
            if (btnEditBooking) {
                btnEditBooking.addEventListener('click', function() {
                    appointmentConfirmationModal.classList.remove('show'); // Hide modal to allow editing
                });
            }

            // Close confirmation modal if user clicks outside
            appointmentConfirmationModal.addEventListener('click', function(e) {
                if (e.target === appointmentConfirmationModal) {
                    appointmentConfirmationModal.classList.remove('show');
                }
            });
        });
    </script>

    <nav class="nav">
        <div class="nav-con">
            <div class="logo">
                <img src="https://lru.ac.th/th/wp-content/uploads/2024/03/LRuQ.png" alt="LRU Logo">
                <a href="#">LRU HeartCare</a>
            </div>
        
            <div class="menu-con">
                <ul class="menu">
                <li><a href="index.html">หน้าแรก</a></li>
                <li><a href="News.html">ข่าวสาร</a></li>
                <li><a href="index.html" id="openQuickAssessment">แบบประเมินสุขภาพใจ</a></li> 
                <li><a href="Psychologist.html">เลือกนักจิตวิยา</a></li>
                <li class="dropdown">
                    <div class="dropdown-toggle">ข้อมูลการนัดหมาย <span class="arrow">▼</span></div>
                    <ul class="dropdown-menu">
                    <li><a href="Viewinfo.html">ข้อมูลการนัดหมาย</a></li>
                    <li><a href="appointments.html">ประวัติการนัดหมาย</a></li>
                    </ul>
                </li>
                </ul>
                <div class="logout">
                <a href="Login.html">ออกจากระบบ</a>
                </div>
            </div>
        </div>
    </nav>

    <main class="appointment-section">
        <div class="psychologist-info-card" id="psychologistInfoCard">
            <img src="" alt="รูปภาพนักจิตวิทยา" id="psychologistImage">
            <h3 id="psychologistName"></h3>
            <p id="psychologistSpecialty"></p>
            <p id="psychologistBio"></p>
            <span class="specialty-tag" id="specialtyTagSpan">รายละเอียดนักจิตวิทยา</span>
        </div>

        <div class="booking-form-card" id="appointmentForm">
            <h2>จองการนัดหมาย</h2>
            <form>
                <div class="form-row">
                    <div class="form-group">
                        <label for="appointmentDate">วันที่นัดหมาย</label>
                        <input type="date" id="appointmentDate" name="appointmentDate" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="appointmentTime">เวลานัดหมาย</label>
                        <input type="time" id="appointmentTime" name="appointmentTime" class="form-control" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="fullName">ชื่อ - นามสกุล</label>
                        <input type="text" id="fullName" name="fullName" class="form-control" placeholder="ชื่อ - นามสกุล" required>
                    </div>
                    <div class="form-group">
                        <label for="studentId">รหัสนักศึกษา</label>
                        <input type="text" id="studentId" name="studentId" class="form-control" placeholder="รหัสนักศึกษา" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="major">สาขา</label>
                        <input type="text" id="major" name="major" class="form-control" placeholder="สาขา" required>
                    </div>
                    <div class="form-group">
                        <label for="faculty">คณะ</label>
                        <input type="text" id="faculty" name="faculty" class="form-control" placeholder="คณะ" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group full-width">
                        <label>ช่องทางการนัดหมาย</label>
                        <div class="form-group appointment-method">
                            <div class="radio-option">
                                <input type="radio" id="methodChat" name="appointmentMethod" value="chat" required>
                                <label for="methodChat">แชท</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="methodClinic" name="appointmentMethod" value="clinic" required>
                                <label for="methodClinic">คลินิก</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="reason">เรื่องที่ต้องการปรึกษา</label>
                        <textarea id="reason" name="reason" class="form-control" placeholder="ระบุเรื่องที่ต้องการปรึกษาโดยละเอียด" rows="4" required></textarea>
                    </div>
                </div>

                <button type="submit" class="submit-btn">ตรวจสอบข้อมูลและยืนยันการนัดหมาย</button>
            </form>
        </div>
    </main>

    <div id="psychologistDetailModal" class="general-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>รายละเอียดนักจิตวิทยา</h3>
            </div>
            <div class="modal-body">
                <img src="" alt="รูปภาพนักจิตวิทยา" id="detailPsyImage">
                <h4 id="detailPsyName"></h4>
                <span class="specialty" id="detailPsySpecialty"></span>
                <p class="bio" id="detailPsyBio"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" id="btnClosePsyDetailModal">ปิด</button>
                <button type="button" class="btn-book-now" id="btnBookNowFromPsyModal">จองการนัดหมายตอนนี้</button>
            </div>
        </div>
    </div>

    <div id="appointmentConfirmationModal" class="general-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ยืนยันข้อมูลการนัดหมาย</h3>
            </div>
            <div class="modal-body">
                <p><strong>ช่องทางการนัดหมาย:</strong> <span id="confirmMethod"></span></p> 
                <p><strong>วันที่นัดหมาย:</strong> <span id="confirmDate"></span></p>
                <p><strong>เวลานัดหมาย:</strong> <span id="confirmTime"></span></p>
                <p><strong>ชื่อ - นามสกุล:</strong> <span id="confirmFullName"></span></p>
                <p><strong>รหัสนักศึกษา:</strong> <span id="confirmStudentId"></span></p>
                <p><strong>สาขา:</strong> <span id="confirmMajor"></span></p>
                <p><strong>คณะ:</strong> <span id="confirmFaculty"></span></p>
                <p><strong>เรื่องที่ต้องการปรึกษา:</strong> <span id="confirmReason"></span></p>
                <p><strong>นักจิตวิทยา:</strong> <span id="confirmPsychologist"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" id="btnEditBooking">แก้ไขข้อมูล</button>
                <button type="button" class="btn-primary" id="btnConfirmBooking">ยืนยันการจอง</button>
            </div>
        </div>
    </div>
</body>
</html>
